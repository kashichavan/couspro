{% extends 'base.html' %}

{% block title %}Smart Enquiry Dashboard{% endblock %}


{% block extra_css %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap');
/* Core Dashboard Styles - Enhanced Version */
*{
      font-family: 'Outfit', sans-serif;
}
:root {

    /* Color System: Orange & White Theme */
    --primary-color: #FF7F00;
    --primary-light: #FFA64D;
    --primary-dark: #E05D00;
    --primary-bg: #FFF5E6;
    --success: #10B981;
    --warning: #FBBF24;
    --danger: #EF4444;
    --gray-50: #F9FAFB;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-300: #D1D5DB;
    --gray-400: #9CA3AF;
    --gray-500: #6B7280;
    --gray-600: #4B5563;
    --gray-700: #374151;
    --gray-800: #1F2937;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

body {
    font-family: 'Poppins', 'Inter', sans-serif;
    background-color: var(--gray-50);
    color: var(--gray-700);
}

.app-wrapper {
    padding: 1.25rem 1rem;
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
}

/* Enhanced Dashboard Header */
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding: 1.25rem 1.5rem;
    background: linear-gradient(120deg, #fff0e6,#FFF8F3);
    border-radius: 12px;
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
    
}

.dashboard-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
    pointer-events: none;
}

.dashboard-title {
    color: #ff6b00;
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    z-index: 1;
}

.dashboard-title i {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem;
    border-radius: 10px;
    font-size: 1.25rem;
    transition: transform 0.3s ease;
}

.dashboard-actions {
    display: flex;
    gap: 0.75rem;
    position: relative;
    z-index: 1;
}

.dashboard-actions .btn {
    font-weight: 500;
    padding: 0.625rem 1rem;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.dashboard-actions .btn:hover {
    transform: translateY(-2px);
}

.dashboard-actions .btn i {
    font-size: 0.875rem;
}
.btn-light,.btn-outline-light{
    background-color: #e45e00;
    color:#fff
}
/* Responsive Card & Table Styles */
.data-card {
    background: white;
    border-radius: 12px;
    box-shadow: var(--shadow);
    overflow: hidden;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card-header {
    background: linear-gradient(120deg, #fff0e6,#FFF8F3);
    padding: 1.25rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.card-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
    pointer-events: none;
}

.card-title {
    color: #ff6b00;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    position: relative;
    z-index: 1;
}

.card-title i {
    font-size: 1.125rem;
}

.data-table-wrapper {
    padding: 1rem;
}

/* Enhanced Responsive Table Styling */
.table-responsive {
    overflow-x: visible;
}

#enquiryTable {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-family: 'Inter', sans-serif;
}

#enquiryTable thead th {
    background: linear-gradient(to right, var(--primary-bg), white);
    color: var(--primary-dark);
    font-weight: 600;
    padding: 0.85rem 0.5rem;
    font-size: 0.815rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    border-bottom: 2px solid var(--primary-light);
    position: relative;
    white-space: normal;
    vertical-align: middle;
}

#enquiryTable thead th::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(to right, var(--primary-color), transparent);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.3s ease;
}

#enquiryTable thead th:hover::after {
    transform: scaleX(1);
}

#enquiryTable tbody tr {
    transition: all 0.2s ease;
    border-bottom: 1px solid var(--gray-200);
}

#enquiryTable tbody tr:last-child {
    border-bottom: none;
}

#enquiryTable tbody tr:hover {
    background-color: var(--primary-bg);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
}

#enquiryTable td {
    padding: 0.75rem 0.5rem;
    vertical-align: middle;
    min-width: 50px;
    word-break: break-word;
}

/* Card content display */
.enquiry-card {
    display: none; /* Hidden by default, shown on mobile */
    background: white;
    border-radius: 10px;
    border: 1px solid var(--gray-200);
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-sm);
    transition: transform 0.2s, box-shadow 0.2s;
}

.enquiry-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.enquiry-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
}

.enquiry-card-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--gray-800);
}

.enquiry-card-type {
    font-size: 0.8rem;
    color: var(--gray-500);
    margin-top: 0.25rem;
}

.enquiry-card-section {
    display: flex;
    justify-content: space-between;
    border-top: 1px solid var(--gray-100);
    padding-top: 0.75rem;
    margin-top: 0.75rem;
}

.enquiry-card-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-bottom: 0.25rem;
    font-weight: 500;
}

.enquiry-card-value {
    font-size: 0.875rem;
}

.enquiry-card-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--gray-100);
}

/* Status Badge Styling */
.status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
}

.status-badge:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.status-badge::before {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
}

.status-joined {
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--success);
}

.status-joined::before {
    background-color: var(--success);
}

.status-pending {
    background-color: rgba(251, 191, 36, 0.1);
    color: var(--warning);
}

.status-pending::before {
    background-color: var(--warning);
}

.status-dropout {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--danger);
}

.status-dropout::before {
    background-color: var(--danger);
}

/* Enhanced Action Buttons */
.action-buttons {
    display: flex;
    gap: 0.5rem;
}

.action-btn {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    color: white;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
}

.action-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: var(--shadow);
}

.view-btn {
    background-color: var(--primary-color);
}

.edit-btn {
    background-color: var(--success);
}

/* Enhanced Comment Styling */
.comment-preview {
    padding: 0.5rem 0;
    cursor: pointer;
    position: relative;
    font-size: 0.85rem;
    color: var(--gray-700);
    transition: all 0.2s ease;
    max-width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.comment-preview:hover {
    color: var(--primary-dark);
}

.comment-preview::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(to right, var(--primary-light), transparent);
    transition: transform 0.3s ease;
    transform: scaleX(0);
    transform-origin: left;
}

.comment-preview:hover::after {
    transform: scaleX(1);
}

.comment-input-group {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
    position: relative;
}

.comment-input {
    border: 1px solid var(--gray-300);
    border-radius: 20px;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    flex-grow: 1;
    transition: all 0.3s ease;
    background-color: var(--gray-50);
}

.comment-input:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 127, 0, 0.1);
    background-color: white;
}

.add-comment-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
    flex-shrink: 0;
}

.add-comment-btn:hover {
    transform: scale(1.1) rotate(15deg);
    box-shadow: var(--shadow);
}

/* Enhanced Follow-up Date Styling */
.followup-date {
    display: inline-flex;
    align-items: center;
    gap: 0.3rem;
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    background-color: var(--primary-bg);
    color: var(--primary-color);
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
    font-size: 0.8rem;
    white-space: nowrap;
}

.followup-date:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow);
}

.followup-date.urgent {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
    }
    70% {
        box-shadow: 0 0 0 5px rgba(239, 68, 68, 0);
    }
    100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
    }
}

/* Enhanced Modal Styling */
.modal-content {
    border: none;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: var(--shadow-lg);
}

.modal-header {
    background: linear-gradient(45deg, var(--primary-dark), var(--primary-color));
    color: white;
    border-bottom: none;
    padding: 1.25rem 1.5rem;
    position: relative;
    overflow: hidden;
}

.modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
    pointer-events: none;
}

.modal-title {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.modal-body {
    padding: 1.5rem;
}

.btn-close {
    background-color: rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    opacity: 1;
    transition: all 0.3s ease;
}

.btn-close:hover {
    background-color: rgba(255, 255, 255, 0.5);
    transform: rotate(90deg);
}

/* Enhanced Comments List */
.comments-container {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 0.5rem;
}

.comment-item {
    background-color: var(--gray-50);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    position: relative;
    border-left: 3px solid var(--primary-color);
    box-shadow: var(--shadow-sm);
    transition: all 0.3s ease;
}

.comment-item:hover {
    transform: translateX(3px);
    box-shadow: var(--shadow);
}

.comment-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-500);
}

.comment-user {
    font-weight: 600;
    color: var(--primary-color);
}

.comment-text {
    color: var(--gray-700);
    font-size: 0.95rem;
    line-height: 1.5;
}

/* Enhanced Alert Styling */
#alertContainer {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    max-width: 350px;
}

.alert {
    border: none;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    box-shadow: var(--shadow-md);
    opacity: 0;
    transform: translateX(20px);
    animation: slideIn 0.3s forwards;
}

@keyframes slideIn {
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.alert-success {
    background-color: rgba(16, 185, 129, 0.1);
    color: var(--success);
    border-left: 4px solid var(--success);
}

.alert-danger {
    background-color: rgba(239, 68, 68, 0.1);
    color: var(--danger);
    border-left: 4px solid var(--danger);
}

/* DataTables Customization */
.dataTables_wrapper .dataTables_filter input {
    border: 1px solid var(--gray-300);
    border-radius: 20px;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    background-color: var(--gray-50);
    transition: all 0.3s ease;
}

.dataTables_wrapper .dataTables_filter input:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 127, 0, 0.1);
    background-color: white;
}

.dataTables_wrapper .dataTables_length select {
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    padding: 0.5rem 1rem; /* Increased from 0.375rem 0.75rem */
    font-size: 1rem; /* Increased from 0.875rem */
    background-color: var(--gray-50);
    transition: all 0.3s ease;
    height: auto; /* Ensure proper height calculation */
    min-height: 2.5rem; /* Add minimum height if needed */
}

/* Keep the focus styles consistent with new sizing */
.dataTables_wrapper .dataTables_length select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 127, 0, 0.1);
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    border-radius: 8px;
    transition: all 0.3s ease;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: linear-gradient(to right, var(--primary-color), var(--primary-light));
    border: none;
    color: white !important;
    font-weight: 500;
}

.dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: var(--primary-bg);
    color: var(--primary-dark) !important;
    border: 1px solid var(--primary-light);
}

/* Loading Animation */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 127, 0, 0.3);
    border-radius: 50%;
    border-top-color: var(--primary-color);
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray-500);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--gray-400);
}

.empty-state h4 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--gray-600);
}

.empty-state p {
    max-width: 400px;
    margin: 0 auto;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--gray-100);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: var(--primary-light);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--primary-color);
}

/* Responsive Adjustments */
@media (max-width: 1200px) {
    .table-responsive {
        overflow-x: auto;
    }
    
    #enquiryTable td, #enquiryTable th {
        min-width: auto;
    }
}

@media (max-width: 992px) {
    .dashboard-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
        padding: 1rem;
    }
    
    .dashboard-title {
        justify-content: center;
        font-size: 1.35rem;
    }
    
    .dashboard-actions {
        width: 100%;
        justify-content: center;
    }
    
    .card-header {
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem;
    }
    
    .card-title {
        justify-content: center;
        font-size: 1.15rem;
    }
    
    .data-table-wrapper {
        padding: 0.75rem;
    }
    
    /* Increase table font size for better touch */
    #enquiryTable td {
        font-size: 0.9rem;
    }
}

@media (max-width: 768px) {
    /* Card view for mobile */
    .table-view {
        display: none;
    }
    
    .card-view {
        display: block;
    }
    
    .app-wrapper {
        padding: 0.75rem;
    }
    
    .dashboard-header {
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .dashboard-title {
        font-size: 1.25rem;
    }
    
    .dashboard-actions .btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
    }
    
    .card-header {
        padding: 0.75rem;
    }
    
    .data-table-wrapper {
        padding: 0.5rem;
    }
}

@media (min-width: 769px) {
    /* Table view for desktop */
    .table-view {
        display: block;
    }
    
    .card-view {
        display: none;
    }
}

/* DataTables Responsive Overrides */
table.dataTable.dtr-inline.collapsed > tbody > tr > td.dtr-control:before,
table.dataTable.dtr-inline.collapsed > tbody > tr > th.dtr-control:before {
    background-color: var(--primary-color) !important;
}

.dt-responsive {
    width: 100% !important;
}

.dtr-details {
    width: 100%;
}

.cell-fit {
    width: 1%;
    white-space: nowrap;
}

/* Improvements for comment column */
.comment-column {
    max-width: 200px;
}

@media (max-width: 992px) {
    .comment-column {
        max-width: 150px;
    }
}

.loader-gear {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}
.loader-gear i {
    font-size: 3rem;
    color: #ffaa00;
}
.loader-gear p {
    margin: 0;
    font-weight: bold;
    color: #333;
}
</style>

{% endblock %}

{% block content %}
<div class="app-wrapper">


      <!-- Global Page Loader -->
<div id="globalLoader" class="loader-overlay">
    <div class="loader-gear">
        <i class="fas fa-cog fa-spin"></i>
        <p>Loading...</p>
    </div>
</div>
    
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">
            <i class="fas fa-comments"></i> 
            Enquiry Dashboard
        </h1>
        <div class="dashboard-actions">
            <a href="{% url 'enquiry:add_enquiry' %}" class="btn btn-light">
                <i class="fas fa-plus"></i> New Enquiry
            </a>
            <a href="{% url 'enquiry:bulk_enquiry_upload' %}" class="btn btn-outline-light">
                <i class="fas fa-file-import"></i> Import
            </a>
        </div>
    </div>
    
    <!-- Alerts container -->
    <div id="alertContainer"></div>
    
    <!-- Enquiry Table Card -->
    <div class="data-card">
        <div class="card-header">
            <h2 class="card-title">
                <i class="fas fa-list"></i> Enquiries
            </h2>
            <div class="d-flex gap-2">
                <button id="refreshTable" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
                <button id="exportCSV" class="btn btn-sm btn-outline-light">
                    <i class="fas fa-download"></i> Export
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="data-table-wrapper">
                <table id="enquiryTable" class="display nowrap w-100">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Course</th>
                            <th>Status</th>
                            <th>Counsellor</th>
                            <th>Follow Up</th>
                            <th>Comments</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for enquiry in enquiries %}
                        <tr id="enquiry-row-{{ enquiry.id }}">
                            <td>
                                <div class="fw-semibold">{{ enquiry.name }}</div>
                                <div class="text-muted small">{{ enquiry.get_enquiry_type_display }}</div>
                            </td>
                            <td>{{ enquiry.mobile }}</td>
                            <td>{{ enquiry.get_subject_display }}</td>
                            <td>
                                <span class="status-badge status-{{ enquiry.status|slugify }}" 
                                      data-status="{{ enquiry.status }}"
                                      data-enquiry-id="{{ enquiry.id }}">
                                    {{ enquiry.get_status_display }}
                                </span>
                            </td>
                            <td>
                                <div class="fw-semibold">{{ enquiry.counsellor.name }}</div>
                                <div class="text-muted small">{{ enquiry.counsellor.department }}</div>
                            </td>
                            <td>
                                <div class="followup-date {% if enquiry.followup_date <= today %}urgent{% endif %}"
                                     data-enquiry-id="{{ enquiry.id }}">
                                    <i class="fas fa-calendar-alt"></i>
                                    {% if enquiry.followup_date %}
                                        {{ enquiry.followup_date|date:"M d" }}
                                    {% else %}
                                        Set Date
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                <div id="comment-container-{{ enquiry.id }}">
                                    {% with enquiry.comments.all|first as comment %}
                                        {% if comment %}
                                            <div class="comment-preview" 
                                                 title="{{ comment.comment }}"
                                                 data-enquiry-id="{{ enquiry.id }}">
                                                {{ comment.comment|truncatechars:30 }}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">No comments</span>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                                <div class="comment-input-group">
                                    <input type="text" 
                                           id="comment-input-{{ enquiry.id }}" 
                                           class="comment-input" 
                                           placeholder="Add comment...">
                                    <button class="add-comment-btn" 
                                            data-enquiry-id="{{ enquiry.id }}">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'enquiry:enquiry_details' enquiry.id %}" 
                                       class="action-btn view-btn" 
                                       title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a href="{% url 'enquiry:edit_enquiry' enquiry.pk %}" 
                                       class="action-btn edit-btn" 
                                       title="Edit Enquiry">
                                        <i class="fas fa-edit"></i>
                                    </a>

                                    <a href="https://wa.me/91{{ enquiry.mobile }}" target="_blank" 
   class="btn btn-success btn-sm rounded-circle d-flex justify-content-center align-items-center"
   style="width: 32px; height: 32px;">
    <i class="fab fa-whatsapp"></i>
</a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Comments Modal -->
<div class="modal fade" id="commentsModal" tabindex="-1" aria-labelledby="commentsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="commentsModalLabel">
                    <i class="fas fa-comments me-2"></i> 
                    Enquiry Comments
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="comments-container" id="commentsList">
                    <!-- Comments loaded dynamically -->
                </div>
                <div class="comment-input-container mt-3">
                    <div class="input-group">
                        <input type="text" id="modalCommentInput" class="form-control" 
                               placeholder="Type your comment...">
                        <button class="btn btn-primary" type="button" id="addCommentModalBtn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Date Picker Modal -->
<div class="modal fade" id="datePickerModal" tabindex="-1" aria-labelledby="datePickerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="datePickerModalLabel">
                    <i class="fas fa-calendar-alt me-2"></i> Set Follow-up Date
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Updated input field -->
                <input type="text" class="form-control" id="followupDateInput" placeholder="Select a date">
                <input type="hidden" id="currentEnquiryId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFollowupDate">Save</button>
            </div>
        </div>
    </div>
</div>
<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">
                    <i class="fas fa-tag me-2"></i>
                    Update Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="statusEnquiryId">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Select New Status</label>
                    <select class="form-select" id="statusSelect">
                        <option value="joined">Joined</option>
                        <option value="pending">Pending</option>
                        <option value="dropout">Dropout</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Status Note (Optional)</label>
                    <textarea class="form-control" id="statusNote" rows="2" placeholder="Add a note about this status change..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStatus">Update</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">
                    <i class="fas fa-tag me-2"></i>
                    Update Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="statusEnquiryId">
                <div class="mb-3">
                    <label class="form-label fw-semibold">Select New Status</label>
                    <select class="form-select" id="statusSelect">
                        <option value="joined">Joined</option>
                        <option value="pending">Pending</option>
                        <option value="dropout">Dropout</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-semibold">Status Note (Optional)</label>
                    <textarea class="form-control" id="statusNote" rows="2" placeholder="Add a note about this status change..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStatus">Update</button>
            </div>
        </div>
    </div>
</div>



<!-- Payment Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"> 
                <h5 class="modal-title" id="paymentModalLabel">
                    <i class="fas fa-rupee-sign me-2"></i> Record Initial Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="paymentEnquiryId">

                <!-- Target Fees -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Target Fees (Total Course Fee)</label>
                    <input type="number" class="form-control" id="targetFees" min="0" step="any">
                </div>

                <!-- Payment Amount -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Payment Amount <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="paymentAmount" min="0" step="any" required>
                </div>

                <!-- Remaining Balance (auto-calculated) -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">Remaining Balance</label>
                    <input type="number" class="form-control" id="remainingBalance" readonly>
                </div>

                <!-- Due Date (shown only if balance > 0) -->
                <div class="mb-3 d-none" id="dueDateContainer">
                    <label class="form-label fw-semibold">Due Date</label>
                    <input type="date" class="form-control" id="dueDate">
                </div>

                <!-- Alert Box -->
                <div id="paymentAlert" class="alert d-none mt-2"></div>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="savePayment">Record Payment</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script>
(function() {
    'use strict';
    
    // Global variables
    let enquiryTable;
    let currentEnquiryId = null;
    
    // Initialize when document is ready
    $(document).ready(function() {
        initializeDataTable();
        setupEventListeners();
        
        // Set current date as default for date picker
        setDefaultFollowupDate();
    });
    
    function initializeDataTable() {
        enquiryTable = $('#enquiryTable').DataTable({
            responsive: true,
            stateSave: true,
            scrollX: true,
            language: {
                search: "",
                searchPlaceholder: "Search enquiries...",
                paginate: {
                    previous: '<i class="fas fa-chevron-left"></i>',
                    next: '<i class="fas fa-chevron-right"></i>'
                },
                info: "Showing _START_ to _END_ of _TOTAL_ entries",
            },
            pageLength: 25,
            order: [[5, 'asc']], // Sort by follow-up date
            columnDefs: [
                { orderable: false, targets: [6, 7] }, // Disable sorting for comments and actions
                { responsivePriority: 1, targets: [0, 3, 5, 7] } // Priority columns
            ]
        });
        
        // Export CSV functionality
        $('#exportCSV').on('click', function() {
            const today = new Date().toISOString().split('T')[0];
            const fileName = `enquiries_export_${today}.csv`;
            
            // Get visible data from the table
            const data = [];
            const headers = [];
            
            // Get headers
            $('#enquiryTable thead th').each(function(index) {
                if (index < 6) { // Skip comments and actions columns
                    headers.push($(this).text());
                }
            });
            
            // Get data
            enquiryTable.rows().every(function() {
                const rowData = this.data();
                const cleanRow = [];
                
                // Extract text content only from first 6 columns
                for (let i = 0; i < 6; i++) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = rowData[i];
                    cleanRow.push(tempDiv.textContent.trim());
                }
                
                data.push(cleanRow);
            });
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            data.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Refresh button
        $('#refreshTable').on('click', function() {
            const btn = $(this);
            btn.html('<i class="fas fa-spinner fa-spin"></i>');
            btn.prop('disabled', true);
            
            // Reload the page
            window.location.reload();
        });
    }
    
    function setupEventListeners() {
        // Comment click handler
        $(document).on('click', '.comment-preview', function() {
            currentEnquiryId = $(this).data('enquiry-id');
            loadComments(currentEnquiryId);
            $('#commentsModal').modal('show');
        });
        
        // Add comment from modal
        $('#addCommentModalBtn').on('click', function() {
            const commentText = $('#modalCommentInput').val().trim();
            if (commentText) {
                submitComment(currentEnquiryId, commentText, $('#modalCommentInput'));
            }
        });
        
        // Add comment from table
        $(document).on('click', '.add-comment-btn', function() {
            const enquiryId = $(this).data('enquiry-id');
            const input = $(`#comment-input-${enquiryId}`);
            const commentText = input.val().trim();
            if (commentText) {
                submitComment(enquiryId, commentText, input);
            }
        });
        
        // Enter key to submit comments
        $(document).on('keypress', '.comment-input, #modalCommentInput', function(e) {
            if (e.which === 13) {
                e.preventDefault();
                const $input = $(this);
                const commentText = $input.val().trim();
                
                if (commentText) {
                    const enquiryId = $input.attr('id') === 'modalCommentInput' 
                        ? currentEnquiryId 
                        : $input.attr('id').split('-')[2];
                    
                    submitComment(enquiryId, commentText, $input);
                }
            }
        });
        
        // Follow-up date click handler
        $(document).on('click', '.followup-date', function() {
            currentEnquiryId = $(this).data('enquiry-id');
            $('#currentEnquiryId').val(currentEnquiryId);
            $('#datePickerModal').modal('show');
        });
        
        // Save follow-up date
        $('#saveFollowupDate').on('click', function() {
            const followupDate = $('#followupDateInput').val();
            const enquiryId = $('#currentEnquiryId').val();
            
            if (followupDate) {
                updateFollowupDate(enquiryId, followupDate);
            }
        });
        
        // Status badge click handler
        $(document).on('click', '.status-badge', function() {
            currentEnquiryId = $(this).data('enquiry-id');
            const currentStatus = $(this).data('status');
            
            $('#statusEnquiryId').val(currentEnquiryId);
            $('#statusSelect').val(currentStatus);
            $('#statusModal').modal('show');
        });
        
        // Save status
        $('#saveStatus').on('click', function() {
            const enquiryId = $('#statusEnquiryId').val();
            const newStatus = $('#statusSelect').val();
            const statusNote = $('#statusNote').val().trim();
            
            updateStatus(enquiryId, newStatus, statusNote);
        });



          // Save payment button handler
    $('#savePayment').on('click', function() {
        const enquiryId = $('#paymentEnquiryId').val();
        const paymentAmount = parseFloat($('#paymentAmount').val());
        const targetFees = parseFloat($('#targetFees').val()) || null;
        
        if (isNaN(paymentAmount) || paymentAmount <= 0) {
            showPaymentAlert('Please enter a valid payment amount', 'danger');
            return;
        }
        
        submitPayment(enquiryId, paymentAmount, targetFees);
    });
    
    // Reset payment modal when closed
    $('#paymentModal').on('hidden.bs.modal', function() {
        $('#paymentAmount').val('');
        $('#targetFees').val('');
        $('#paymentAlert').addClass('d-none').html('');
    });

    }


    const targetInput = document.getElementById("targetFees");
    const amountInput = document.getElementById("paymentAmount");
    const balanceInput = document.getElementById("remainingBalance");
    const dueDateContainer = document.getElementById("dueDateContainer");
    const dueDateInput = document.getElementById("dueDate");

    function calculateBalanceAndDueDate() {
        const target = parseFloat(targetInput.value) || 0;
        const amount = parseFloat(amountInput.value) || 0;
        const balance = target - amount;

        balanceInput.value = balance.toFixed(2);

        if (balance > 0) {
            dueDateContainer.classList.remove("d-none");

            // Auto fill due date = today + 7 days
            const due = new Date();
            due.setDate(due.getDate() + 7);
            dueDateInput.value = due.toISOString().split("T")[0];
        } else {
            dueDateContainer.classList.add("d-none");
            dueDateInput.value = '';
        }
    }

    // Event Listeners
    targetInput.addEventListener("input", calculateBalanceAndDueDate);
    amountInput.addEventListener("input", calculateBalanceAndDueDate);

    // Add this function to handle payment submission
function submitPayment(enquiryId, paymentAmount, targetFees) {
    const btn = $('#savePayment');
    btn.prop('disabled', true);

    const dueDate = $('#dueDateInput').val();  // <--- Add this line

    $.ajax({
        url: '{% url "enquiry:update_payment" %}',
        method: 'POST',
        data: {
            enquiry_id: enquiryId,
            payment_amount: paymentAmount,
            target_fees: targetFees,
            due_date: dueDate,  // <--- Send due_date
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                showPaymentAlert('Payment recorded successfully!', 'success');
                setTimeout(() => {
                    $('#paymentModal').modal('hide');
                    const badge = $(`.status-badge[data-enquiry-id="${enquiryId}"]`);
                    badge.removeClass().addClass('status-badge status-joined')
                         .text('Joined')
                         .data('status', 'joined');
                }, 1500);
            } else {
                showPaymentAlert(response.error || 'Failed to record payment', 'danger');
            }
        },
        error: function() {
            showPaymentAlert('An error occurred', 'danger');
        },
        complete: function() {
            btn.prop('disabled', false);
        }
    });
}

// Add this function to show alerts in payment modal
function showPaymentAlert(message, type) {
    const alert = $('#paymentAlert');
    alert.removeClass('d-none')
         .removeClass('alert-success alert-danger alert-info')
         .addClass(`alert-${type}`)
         .html(`<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle me-2"></i> ${message}`);
}

    
    // Function to load comments for an enquiry
    function loadComments(enquiryId) {
        $('#commentsList').html('<div class="text-center p-3"><i class="fas fa-spinner fa-spin"></i></div>');
        
        $.ajax({
            url: '{% url "enquiry:get_comments" %}',
            data: { enquiry_id: enquiryId },
            success: function(response) {
                $('#commentsList').html(response);
            },
            error: function() {
                $('#commentsList').html(`
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Failed to load comments
                    </div>
                `);
            }
        });
    }



    
    
    // Function to submit a comment
    function submitComment(enquiryId, commentText, inputField) {
        inputField.prop('disabled', true);
        
        $.ajax({
            url: '{% url "enquiry:add_comment" %}',
            method: 'POST',
            data: {
                enquiry_id: enquiryId,
                comment: commentText,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Clear the input
                    inputField.val('');
                    
                    // Update the comment preview in the table
                    $(`#comment-container-${enquiryId}`).html(`
                        <div class="comment-preview" 
                             title="${commentText}"
                             data-enquiry-id="${enquiryId}">
                            ${response.truncated_comment}
                        </div>
                    `);
                    
                    // If comments modal is open, reload comments
                    if ($('#commentsModal').is(':visible')) {
                        loadComments(enquiryId);
                    }
                    
                    showAlert('Comment added successfully', 'success');
                } else {
                    showAlert(response.message || 'Failed to add comment', 'danger');
                }
            },
            error: function() {
                showAlert('An error occurred', 'danger');
            },
            complete: function() {
                inputField.prop('disabled', false).focus();
            }
        });
    }
    
    // Function to update follow-up date
    function updateFollowupDate(enquiryId, followupDate) {
        $('#saveFollowupDate').prop('disabled', true);
        
        $.ajax({
            url: '{% url "enquiry:update_followup_date" %}',
            method: 'POST',
            data: {
                enquiry_id: enquiryId,
                followup_date: followupDate,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Format date for display
                    const dateObj = new Date(followupDate);
                    const month = dateObj.toLocaleString('default', { month: 'short' });
                    const day = dateObj.getDate();
                    
                    // Update the follow-up date display
                    const dateDisplay = $(`.followup-date[data-enquiry-id="${enquiryId}"]`);
                    dateDisplay.html(`<i class="fas fa-calendar-alt"></i> ${month} ${day}`);
                    
                    // Check if date is in the past
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    dateObj.setHours(0, 0, 0, 0);
                    
                    if (dateObj <= today) {
                        dateDisplay.addClass('urgent');
                    } else {
                        dateDisplay.removeClass('urgent');
                    }
                    
                    $('#datePickerModal').modal('hide');
                    showAlert('Follow-up date updated', 'success');
                } else {
                    showAlert(response.message || 'Failed to update date', 'danger');
                }
            },
            error: function() {
                showAlert('An error occurred', 'danger');
            },
            complete: function() {
                $('#saveFollowupDate').prop('disabled', false);
            }
        });
    }
    
    function updateStatus(enquiryId, newStatus, statusNote) {
    $('#saveStatus').prop('disabled', true);
    
    $.ajax({
        url: '{% url "enquiry:update_status" %}',
        method: 'POST',
        data: {
            enquiry_id: enquiryId,
            new_status: newStatus,
            status_note: statusNote,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.status === 'success') {
                // If status is set to joined, open payment modal
                if (newStatus === 'joined') {
                    $('#statusModal').modal('hide');
                    $('#paymentEnquiryId').val(enquiryId);
                    $('#paymentModal').modal('show');
                } else {
                    // Update status for other cases
                    const badge = $(`.status-badge[data-enquiry-id="${enquiryId}"]`);
                    badge.removeClass()
                         .addClass(`status-badge status-${newStatus}`)
                         .text(response.new_status_display)
                         .data('status', newStatus);
                    
                    $('#statusModal').modal('hide');
                    showAlert('Status updated', 'success');
                }
                
                
                // Clear the status note field
                $('#statusNote').val('');
            } else {
                showAlert(response.message || 'Failed to update status', 'danger');
            }
        },
        error: function() {
            showAlert('An error occurred', 'danger');
        },
        complete: function() {
            $('#saveStatus').prop('disabled', false);
        }
    });
}

    
    // Show alert message
    function showAlert(message, type) {
        const alertId = `alert-${Date.now()}`;
        const alert = $(`
            <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show mb-3">
                <div class="d-flex align-items-center">
                    ${type === 'success' ? '<i class="fas fa-check-circle me-2"></i>' : ''}
                    ${type === 'danger' ? '<i class="fas fa-exclamation-circle me-2"></i>' : ''}
                    ${message}
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `);
        
        $('#alertContainer').prepend(alert);
        
        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            $(`#${alertId}`).fadeOut(300, function() {
                $(this).remove();
            });
        }, 3000);
    }
    
    // Set default follow-up date to today
    function setDefaultFollowupDate() {
        const today = new Date().toISOString().split('T')[0];
        $('#followupDateInput').val(today);
    }
})();

  // Initialize Flatpickr
document.addEventListener('DOMContentLoaded', function () {
    flatpickr("#followupDateInput", {
        altInput: true,
        altFormat: "F j, Y", // Display format
        dateFormat: "Y-m-d",  // Internal format
        minDate: "today",     // Prevent past dates
        defaultDate: new Date(), // Default to today
        theme: "light",       // Optional: choose theme
        onChange: function(selectedDates, dateStr, instance) {
            // Optional: Trigger behavior when date changes
        }
    });
     function setDefaultFollowupDate() {
        const today = new Date().toISOString().split('T')[0];
        $('#followupDateInput').val(today);
    }
});
</script>
{% endblock %}