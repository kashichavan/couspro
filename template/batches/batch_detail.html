{% extends 'base.html' %}
{% load static %}
{% load custom_filters1  %}

{% block title %}{{ title }} - Enquiry Portal{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
 <style>
        /* ====================================
           BATCH MANAGEMENT - ORANGE THEME CSS
           ==================================== */

        /* Reset and Base Styles */
        .batch-management * {
            box-sizing: border-box;
        }

        .batch-management {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #fefefe;
        }

        /* ====================================
           HEADER SECTION
           ==================================== */
        .batch-header {
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(255, 140, 66, 0.3);
        }

        .batch-header h2 {
            font-size: 2rem;
            font-weight: 700;
            margin: 0 0 1rem 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .batch-info {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-top: 1rem;
        }

        .batch-info-item {
            display: flex;
            flex-direction: column;
        }

        .batch-info-label {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .batch-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        /* ====================================
           NAVIGATION TABS
           ==================================== */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 0;
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            color: #6c757d;
            padding: 1rem 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            margin-right: 0.5rem;
        }

        .nav-tabs .nav-link:hover {
            color: #ff6b35;
            background-color: #fff5f2;
            transform: translateY(-2px);
        }

        .nav-tabs .nav-link.active {
            color: #ff6b35;
            background-color: white;
            border-bottom: 3px solid #ff6b35;
        }

        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff8c42, #ff6b35);
            border-radius: 2px;
        }

        /* ====================================
           TAB CONTENT
           ==================================== */
        .tab-content {
            background: white;
            border-radius: 0 12px 12px 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            min-height: 400px;
        }

        /* ====================================
           CONTROLS BAR
           ==================================== */
        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .controls-left {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .controls-right {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* Search Box */
        .search-box {
            border: 2px solid #e9ecef;
            border-radius: 25px;
            padding: 0.75rem 1.25rem;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #fff5f2;
            min-width: 280px;
        }

        .search-box:focus {
            outline: none;
            border-color: #ff6b35;
            background: white;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
            transform: scale(1.02);
        }

        .search-box::placeholder {
            color: #adb5bd;
            font-style: italic;
        }

        /* Action Buttons */
        .action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .action-btn-primary {
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            color: white;
        }

        .action-btn-primary:hover {
            background: linear-gradient(135deg, #ff7b28 0%, #ff5722 100%);
        }

        .action-btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
        }

        .action-btn-danger:hover {
            background: linear-gradient(135deg, #ff5252 0%, #dc4c41 100%);
        }

        .action-btn-outline {
            background: white;
            color: #ff6b35;
            border: 2px solid #ff6b35;
        }

        .action-btn-outline:hover {
            background: #ff6b35;
            color: white;
        }

        /* ====================================
           TABLE STYLES
           ==================================== */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }

        .table {
            margin: 0;
            font-size: 0.95rem;
        }

        .table thead {
            background: linear-gradient(135deg, #fff5f2 0%, #ffe8e0 100%);
        }

        .table thead th {
            border: none;
            font-weight: 700;
            color: #ff6b35;
            padding: 1.25rem 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.85rem;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table tbody tr {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .table tbody tr:hover {
            background-color: rgba(255, 140, 66, 0.05) !important;
            transform: scale(1.01);
        }

        .table tbody tr.selected {
            background-color: rgba(255, 140, 66, 0.1) !important;
            border-left: 4px solid #ff6b35;
        }

        .table tbody td {
            padding: 1rem;
            border-top: 1px solid #e9ecef;
            vertical-align: middle;
        }

        .table tbody tr:first-child td {
            border-top: none;
        }

        /* Table Cell Specific Styles */
        .student-name {
            font-weight: 600;
            color: #495057;
        }

        .student-mobile {
            color: #6c757d;
            font-family: 'Courier New', monospace;
        }

        .amount {
            font-weight: 700;
            font-family: 'Courier New', monospace;
            text-align: right;
        }

        .amount-success {
            color: #28a745;
        }

        .amount-danger {
            color: #dc3545;
        }

        .amount-warning {
            color: #ff6b35;
        }

        /* Due Date Badges */
        .due-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #fff5f2;
            color: #ff6b35;
            border: 1px solid #ffccc7;
        }

        .due-badge-danger {
            background: #ffebee;
            color: #d32f2f;
            border-color: #ffcdd2;
            animation: pulse-danger 2s infinite;
        }

        .due-badge-warning {
            background: #fff3e0;
            color: #f57c00;
            border-color: #ffcc02;
        }

        @keyframes pulse-danger {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ====================================
           ACTION BUTTONS IN TABLE
           ==================================== */
        .btn-group-sm .btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            border-radius: 6px;
            margin-right: 0.25rem;
            transition: all 0.3s ease;
        }

        .btn-group-sm .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .btn-outline-primary {
            border-color: #ff6b35;
            color: #ff6b35;
        }

        .btn-outline-primary:hover {
            background-color: #ff6b35;
            border-color: #ff6b35;
            color: white;
        }

        .btn-outline-secondary {
            border-color: #6c757d;
            color: #6c757d;
        }

        .btn-outline-secondary:hover {
            background-color: #6c757d;
            border-color: #6c757d;
            color: white;
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        /* ====================================
           PAGINATION
           ==================================== */
        .table-pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: #fff5f2;
            border-top: 1px solid #e9ecef;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination-info {
            color: #6c757d;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .pagination-btn {
            background: white;
            border: 2px solid #e9ecef;
            color: #6c757d;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            border-color: #ff6b35;
            color: #ff6b35;
            transform: translateY(-1px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #assigned-page-info,
        #unassigned-page-info {
            font-weight: 600;
            color: #ff6b35;
            min-width: 100px;
            text-align: center;
        }

        /* ====================================
           NO RESULTS MESSAGE
           ==================================== */
        .no-results {
            text-align: center;
            padding: 3rem 2rem;
            color: #6c757d;
        }

        .no-results i {
            font-size: 3rem;
            color: #ffccc7;
            margin-bottom: 1rem;
        }

        .no-results p {
            font-size: 1.1rem;
            margin: 0;
        }

        /* ====================================
           PAYMENT SUMMARY
           ==================================== */
        .payment-summary {
            background: linear-gradient(135deg, #ff8c42 0%, #ff6b35 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2rem;
            box-shadow: 0 8px 32px rgba(255, 140, 66, 0.3);
        }

        .payment-summary h5 {
            font-weight: 700;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .payment-summary .table {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            overflow: hidden;
        }

        .payment-summary .table th,
        .payment-summary .table td {
            border: none;
            color: white;
            font-weight: 600;
            padding: 1rem;
        }

        .payment-summary .table thead th {
            background: rgba(255,255,255,0.1);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .payment-summary .table tbody td {
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
        }

        /* ====================================
           CHECKBOXES
           ==================================== */
        input[type="checkbox"] {
            width: 1.2rem;
            height: 1.2rem;
            accent-color: #ff6b35;
            cursor: pointer;
        }

        /* ====================================
           ANIMATIONS
           ==================================== */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-pane {
            animation: fadeIn 0.5s ease;
        }

        .table tbody tr {
            animation: fadeIn 0.3s ease;
        }

        /* ====================================
           RESPONSIVE DESIGN
           ==================================== */
        @media (max-width: 768px) {
            .batch-header {
                padding: 1.5rem;
            }
            
            .batch-header h2 {
                font-size: 1.5rem;
            }
            
            .batch-info {
                flex-direction: column;
                gap: 1rem;
            }
            
            .tab-content {
                padding: 1rem;
            }
            
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .table-pagination {
                flex-direction: column;
                text-align: center;
            }
            
            .pagination-controls {
                justify-content: center;
            }
        }



.nav-tabs {
   border-bottom: 2px solid #f8d7b0;
   margin-bottom: 1.5rem;
}

.nav-tabs .nav-item {
   margin-bottom: -2px;
}

.nav-tabs .nav-link {
   border: 2px solid transparent;
   border-radius: 0.5rem 0.5rem 0 0;
   padding: 0.75rem 1.5rem;
   color: #ff7f00;
   background-color: #fff7f0;
   font-weight: 500;
   transition: all 0.3s ease;
   position: relative;
   overflow: hidden;
}

.nav-tabs .nav-link:hover {
   border-color: #fbc490;
   background-color: #ffe9d6;
   color: #cc6600;
   transform: translateY(-2px);
}

.nav-tabs .nav-link.active {
   color: #ffffff;
   background: linear-gradient(135deg, #ffa500 0%, #ff6a00 100%);
   border-color: #ffa500;
   box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
}

.nav-tabs .nav-link.active::before {
   content: '';
   position: absolute;
   top: 0;
   left: -100%;
   width: 100%;
   height: 100%;
   background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
   transition: left 0.5s;
}

.nav-tabs .nav-link.active:hover::before {
   left: 100%;
}

.nav-tabs .nav-link:focus {
   outline: none;
   box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.25);
}

@media (max-width: 576px) {
   .nav-tabs .nav-link {
       padding: 0.5rem 1rem;
       font-size: 0.9rem;
   }
}

/* Gradient background card */


.gradient-card {
    background: linear-gradient(135deg, #ff7a18, #fcd757);
    border-radius: 1rem;
    color: white;
    transition: box-shadow 0.3s ease;
}
.gradient-card:hover {
    box-shadow: 0 10px 30px rgba(255, 123, 24, 0.3);
}

.text-gradient {
    background: linear-gradient(to right, #ff7a18, #ffae00);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* Info chips */
.info-chip {
    background: #ffffff;
    border-radius: 1rem;
    padding: 1.2rem 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    flex: 1 1 250px;
    border: 1px solid #f3f3f3;
    transition: all 0.2s ease-in-out;
}

.info-chip:hover {
    transform: translateY(-4px);
    box-shadow: 0 10px 18px rgba(255, 122, 24, 0.1);
}

.chip-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.4rem;
}

.chip-label {
    font-size: 0.85rem;
    color: #888;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
}

.chip-value {
    font-size: 1.3rem;
    font-weight: 600;
}

.text-orange {
    color: #ff7a18;
}



    </style>

{% endblock %}
{% block content %}

<!-- ✅ Local DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<!-- ✅ Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="container my-4">
    <!-- Batch Header with Orange-White Gradient -->
    <div class="gradient-card mb-4 p-4 shadow">
        <h2 class="text-white mb-3">
            <i class="fas fa-layer-group me-2"></i>Batch: {{ batch.code }} - {{ batch.subject }}
        </h2>
        <p class="text-50 mb-1"><strong>Trainer:</strong> {{ batch.trainer }}</p>
        <p class="text-50 mb-1"><strong>Tracker:</strong> {{ batch.tracker }}</p>
        <p class="text-50"><strong>Remarks:</strong> {{ batch.remarks }}</p>
    </div>

    {% if assigned %}
    <!-- Payment Summary Title -->
    <div class="d-flex align-items-center justify-content-between mb-3">
        <h4 class="text-gradient fw-bold mb-0">
            <i class="fas fa-wallet me-2"></i>Batch Payment Summary
        </h4>
    </div>

    <!-- Info Chips Row -->
    <div class="d-flex flex-wrap gap-3">
        <!-- Total Target -->
        <div class="info-chip shadow">
            <div class="chip-icon bg-light text-warning"><i class="fas fa-bullseye"></i></div>
            <div>
                <div class="chip-label">Total Target</div>
                <div class="chip-value text-orange">₹{{ batch_payment_summary.total_target }}</div>
            </div>
        </div>

        <!-- Total Paid -->
        <div class="info-chip shadow">
            <div class="chip-icon bg-light text-success"><i class="fas fa-check-circle"></i></div>
            <div>
                <div class="chip-label">Total Paid</div>
                <div class="chip-value text-success">₹{{ batch_payment_summary.total_paid }}</div>
            </div>
        </div>

        <!-- Total Balance -->
        <div class="info-chip shadow">
            <div class="chip-icon bg-light text-danger"><i class="fas fa-hourglass-half"></i></div>
            <div>
                <div class="chip-label">Total Balance</div>
                <div class="chip-value text-danger">₹{{ batch_payment_summary.total_balance }}</div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
<!-- Tab Navigation - Add this BEFORE the div class="tab-content mt-3" -->
<ul class="nav nav-tabs mb-0" id="batchTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="assigned-tab" data-bs-toggle="tab" 
                data-bs-target="#assigned" type="button" role="tab" 
                aria-controls="assigned" aria-selected="true">
            <i class="fas fa-users me-2"></i>
            Assigned Students
            <span class="badge bg-primary ms-2" id="assigned-count">{{ assigned|length }}</span>
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="unassigned-tab" data-bs-toggle="tab" 
                data-bs-target="#unassigned" type="button" role="tab" 
                aria-controls="unassigned" aria-selected="false">
            <i class="fas fa-user-plus me-2"></i>
            Unassigned Students
            <span class="badge bg-secondary ms-2" id="unassigned-count">{{ unassigned|length }}</span>
        </button>
    </li>
</ul>

<div class="tab-content mt-3" id="batchTabsContent">
    <!-- Assigned Students -->
    <div class="tab-pane fade show active" id="assigned" role="tabpanel">
        {% if assigned %}
        <form method="post" action="{% url 'batch:bulk_remove_from_batch' batch.id %}" id="bulk-remove-form">
            {% csrf_token %}
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div>
                    <button type="submit" class="btn btn-danger btn-sm">Remove Selected</button>
                    <button type="button" class="btn btn-success btn-sm ms-2" id="downloadAssigned">
                        <i class="fas fa-download me-1"></i> Download List
                    </button>
                </div>
                <input type="text" id="searchAssigned" class="search-box" style="width: 250px;" placeholder="Search assigned students...">
            </div>
            
            <div class="table-container">
                <table id="assigned-table" class="table table-bordered table-hover">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select_all_assigned"></th>
                            <th>Name</th>
                            <th>Contact</th>
                            <th>Target Fees</th>
                            <th>Paid</th>
                            <th>Balance</th>
                            <th>Due Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assigned-tbody">
                        {% for student in assigned %}
                        {% with payment=payment_data|get_item:student.id %}
                        <tr class="student-row" data-id="{{ student.id }}" 
                            data-name="{{ student.name }}"
                            data-mobile="{{ student.mobile }}"
                            data-balance="{{ payment.balance|default:0 }}"
                            data-due-date="{{ student.due_date|date:'Y-m-d' }}">
                            <td><input type="checkbox" name="enquiry_ids" value="{{ student.id }}"></td>
                            <td>{{ student.name }}</td>
                            <td>{{ student.mobile }}</td>
                            <td class="amount">₹{{ payment.target|default:"0.00" }}</td>
                            <td class="amount amount-success">₹{{ payment.paid|default:"0.00" }}</td>
                            <td class="amount amount-danger">₹{{ payment.balance|default:"0.00" }}</td>
                            <td>
                                {% if student.due_date %}
                                    <span class="due-badge {% if student.due_date < today %}due-badge-danger{% endif %}">
                                        {{ student.due_date|date:"d M, Y" }}
                                    </span>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary update-payment-btn" 
                                            data-bs-toggle="modal" data-bs-target="#updatePaymentModal"
                                            title="Update Payment">
                                        <i class="fas fa-dollar-sign"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary update-date-btn"
                                            data-bs-toggle="modal" data-bs-target="#updateDueDateModal"
                                            title="Update Due Date">
                                        <i class="fas fa-calendar-alt"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="submitSingleRemove({{ batch.id }}, {{ student.id }})">
                                        Remove
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endwith %}
                        {% endfor %}
                    </tbody>
                </table>
                <div id="assigned-no-results" class="no-results" style="display: none;">
                    <i class="fas fa-search"></i>
                    <p>No students found matching your search.</p>
                </div>
            </div>
            
            <div class="table-pagination">
                <div class="pagination-info" id="assigned-info">
                    Showing <span id="assigned-start">1</span> to <span id="assigned-end">{{ assigned|length }}</span> of <span id="assigned-total">{{ assigned|length }}</span> students
                </div>
                <div class="pagination-controls">
                    <button type="button" class="pagination-btn" id="assigned-prev" onclick="changePage('assigned', -1)">‹ Previous</button>
                    <span id="assigned-page-info">Page 1</span>
                    <button type="button" class="pagination-btn" id="assigned-next" onclick="changePage('assigned', 1)">Next ›</button>
                </div>
            </div>
        </form>
        {% else %}
        <div class="alert alert-info">No students assigned to this batch.</div>
        {% endif %}
    </div>

    <!-- Unassigned Students -->
    <div class="tab-pane fade" id="unassigned" role="tabpanel">
        {% if unassigned %}
        <form method="post" action="{% url 'batch:bulk_assign_to_batch' batch.id %}" id="bulk-assign-form">
            {% csrf_token %}
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div>
                    <button type="submit" class="btn btn-primary btn-sm">Assign Selected</button>
                    <button type="button" class="btn btn-success btn-sm ms-2" id="downloadUnassigned">
                        <i class="fas fa-download me-1"></i> Download List
                    </button>
                </div>
                <input type="text" id="searchUnassigned" class="search-box" style="width: 250px;" placeholder="Search by name or mobile...">
            </div>
            
            <div class="table-container">
                <table id="unassigned-table" class="table table-striped">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select_all_unassigned"></th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unassigned-tbody">
                        {% for student in unassigned %}
                        <tr class="student-row" data-name="{{ student.name }}" data-mobile="{{ student.mobile }}">
                            <td><input type="checkbox" name="enquiry_ids" value="{{ student.id }}"></td>
                            <td>{{ student.name }}</td>
                            <td>{{ student.mobile }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary" onclick="submitSingleAssign({{ batch.id }}, {{ student.id }})">
                                    Assign
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="unassigned-no-results" class="no-results" style="display: none;">
                    <i class="fas fa-search"></i>
                    <p>No students found matching your search.</p>
                </div>
            </div>
            
            <div class="table-pagination">
                <div class="pagination-info" id="unassigned-info">
                    Showing <span id="unassigned-start">1</span> to <span id="unassigned-end">{{ unassigned|length }}</span> of <span id="unassigned-total">{{ unassigned|length }}</span> students
                </div>
                <div class="pagination-controls">
                    <button type="button" class="pagination-btn" id="unassigned-prev" onclick="changePage('unassigned', -1)">‹ Previous</button>
                    <span id="unassigned-page-info">Page 1</span>
                    <button type="button" class="pagination-btn" id="unassigned-next" onclick="changePage('unassigned', 1)">Next ›</button>
                </div>
            </div>
        </form>
        {% else %}
        <div class="alert alert-info">No unassigned students available.</div>
        {% endif %}
    </div>
</div>
<!-- ✅ Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11"></div>

<!-- ✅ Update Payment Modal -->
<div class="modal fade" id="updatePaymentModal" tabindex="-1" aria-labelledby="updatePaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updatePaymentModalLabel">
                    <i class="fas fa-money-bill-wave"></i>
                    Update Payment
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updatePaymentForm">
                    <input type="hidden" id="payment_enquiry_id">
                    <div class="mb-3">
                        <label for="balanceFees" class="form-label fw-semibold">Balance Fees</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="text" class="form-control" id="balanceFees" readonly>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="paymentAmount" class="form-label fw-semibold">Payment Amount</label>
                        <div class="input-group">
                            <span class="input-group-text">₹</span>
                            <input type="number" class="form-control" id="paymentAmount" min="1" step="1" required>
                        </div>
                        <div class="form-text text-muted">Enter the amount received from the student</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitPayment">
                    <i class="fas fa-check me-2"></i>
                    Update Payment
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Update Due Date Modal -->
<div class="modal fade" id="updateDueDateModal" tabindex="-1" aria-labelledby="updateDueDateModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateDueDateModalLabel">
                    <i class="fas fa-calendar-alt"></i>
                    Update Due Date
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateDueDateForm">
                    <input type="hidden" id="duedate_student_id">
                    <div class="mb-3">
                        <label for="dueDateStudentName" class="form-label fw-semibold">Student Name</label>
                        <input type="text" class="form-control" id="dueDateStudentName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="currentDueDate" class="form-label fw-semibold">Current Due Date</label>
                        <input type="text" class="form-control" id="currentDueDate" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="newDueDate" class="form-label fw-semibold">New Due Date</label>
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="text" class="form-control datepicker" id="newDueDate" placeholder="Select a date" required>
                        </div>
                        <div class="form-text text-muted">Select a new due date for payment</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitDueDate">
                    <i class="fas fa-check me-2"></i>
                    Update Due Date
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ✅ Hidden CSRF Token for JS -->
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" id="csrf_token">

{% endblock %}

{% block extra_js %}

<!-- ✅ Vendor Scripts -->


<!-- ✅ Main Script -->
<script>
// ✅ Global variables for pagination
let currentPage = {
    assigned: 1,
    unassigned: 1
};
let rowsPerPage = 10;
let filteredData = {
    assigned: [],
    unassigned: []
};

// ✅ Reusable Functions
function showToast(title, message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container');
    const toastId = 'toast-' + Date.now();
    const typeConfig = {
        success: { bg: 'bg-success', icon: 'fa-check-circle' },
        error: { bg: 'bg-danger', icon: 'fa-exclamation-circle' },
        warning: { bg: 'bg-warning', icon: 'fa-exclamation-triangle' },
        info: { bg: 'bg-info', icon: 'fa-info-circle' }
    };
    const config = typeConfig[type] || typeConfig.info;
    
    const toastHTML = `
        <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
            <div class="toast-header ${config.bg} text-white">
                <i class="fas ${config.icon} me-2"></i>
                <strong class="me-auto">${title}</strong>
                <small>Just now</small>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHTML);
    new bootstrap.Toast(document.getElementById(toastId)).show();
    
    document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function formatDateForDisplay(dateString) {
    return new Date(dateString).toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short', 
        day: '2-digit' 
    });
}

// ✅ Search functionality
function searchTable(tableType) {
    const searchInput = document.getElementById(`search${tableType.charAt(0).toUpperCase() + tableType.slice(1)}`);
    const searchTerm = searchInput.value.toLowerCase().trim();
    const rows = document.querySelectorAll(`#${tableType}-tbody .student-row`);
    const noResultsDiv = document.getElementById(`${tableType}-no-results`);
    
    let visibleRows = [];
    let hasVisibleRows = false;
    
    rows.forEach(row => {
        const name = row.dataset.name.toLowerCase();
        const mobile = row.dataset.mobile.toLowerCase();
        const isMatch = name.includes(searchTerm) || mobile.includes(searchTerm);
        
        if (isMatch) {
            visibleRows.push(row);
            hasVisibleRows = true;
        }
    });
    
    // Store filtered data
    filteredData[tableType] = visibleRows;
    currentPage[tableType] = 1; // Reset to first page
    
    // Show/hide no results message
    if (hasVisibleRows) {
        noResultsDiv.style.display = 'none';
        displayPage(tableType);
    } else {
        noResultsDiv.style.display = 'block';
        hideAllRows(tableType);
        updatePaginationInfo(tableType, 0, 0, 0);
    }
}

function hideAllRows(tableType) {
    const rows = document.querySelectorAll(`#${tableType}-tbody .student-row`);
    rows.forEach(row => row.style.display = 'none');
}

function displayPage(tableType) {
    const data = filteredData[tableType];
    const startIndex = (currentPage[tableType] - 1) * rowsPerPage;
    const endIndex = Math.min(startIndex + rowsPerPage, data.length);
    
    // Hide all rows first
    hideAllRows(tableType);
    
    // Show rows for current page
    for (let i = startIndex; i < endIndex; i++) {
        if (data[i]) {
            data[i].style.display = '';
        }
    }
    
    updatePaginationInfo(tableType, startIndex + 1, endIndex, data.length);
    updatePaginationButtons(tableType);
}

function updatePaginationInfo(tableType, start, end, total) {
    document.getElementById(`${tableType}-start`).textContent = start;
    document.getElementById(`${tableType}-end`).textContent = end;
    document.getElementById(`${tableType}-total`).textContent = total;
    
    const totalPages = Math.ceil(total / rowsPerPage);
    document.getElementById(`${tableType}-page-info`).textContent = 
        totalPages > 0 ? `Page ${currentPage[tableType]} of ${totalPages}` : 'Page 0 of 0';
}

function updatePaginationButtons(tableType) {
    const data = filteredData[tableType];
    const totalPages = Math.ceil(data.length / rowsPerPage);
    
    document.getElementById(`${tableType}-prev`).disabled = currentPage[tableType] <= 1;
    document.getElementById(`${tableType}-next`).disabled = currentPage[tableType] >= totalPages;
}

function changePage(tableType, direction) {
    const data = filteredData[tableType];
    const totalPages = Math.ceil(data.length / rowsPerPage);
    
    const newPage = currentPage[tableType] + direction;
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage[tableType] = newPage;
        displayPage(tableType);
    }
}

// ✅ Initialize tables
function initializeTable(tableType) {
    const rows = document.querySelectorAll(`#${tableType}-tbody .student-row`);
    filteredData[tableType] = Array.from(rows);
    displayPage(tableType);
}

// ✅ Payment Update Handlers
const paymentModal = new bootstrap.Modal(document.getElementById('updatePaymentModal'));
document.addEventListener('click', function(e) {
    if (e.target.closest('.update-payment-btn')) {
        const btn = e.target.closest('.update-payment-btn');
        const row = btn.closest('tr');
        const studentId = row.dataset.id;
        const balance = row.dataset.balance;
        
        document.getElementById('payment_enquiry_id').value = studentId;
        document.getElementById('balanceFees').value = parseFloat(balance).toFixed(0);
        document.getElementById('paymentAmount').value = '';
        
        paymentModal.show();
        setTimeout(() => document.getElementById('paymentAmount').focus(), 300);
    }
});

document.getElementById('submitPayment').addEventListener('click', function() {
    const enquiryId = document.getElementById('payment_enquiry_id').value;
    const paymentAmountInput = document.getElementById('paymentAmount');
    const paymentAmount = paymentAmountInput.value;
    const balanceFees = parseFloat(document.getElementById('balanceFees').value);
    
    if (!paymentAmount || isNaN(paymentAmount) || parseFloat(paymentAmount) <= 0) {
        showToast('Validation Error', 'Please enter a valid payment amount', 'error');
        return;
    }
    
    if (parseFloat(paymentAmount) > balanceFees) {
        showToast('Validation Error', 'Payment amount cannot exceed balance fees', 'error');
        return;
    }
    
    const submitBtn = this;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    submitBtn.disabled = true;
    
    fetch('{% url "enquiry:update_payment" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `enquiry_id=${encodeURIComponent(enquiryId)}&payment_amount=${encodeURIComponent(paymentAmount)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updatePaymentInTable(enquiryId, data);
            showToast('Success', 'Payment updated successfully!', 'success');
            paymentModal.hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('Error', data.message || 'Failed to update payment', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network Error', 'Please check your connection and try again', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function updatePaymentInTable(enquiryId, data) {
    const row = document.querySelector(`tr[data-id="${enquiryId}"]`);
    if (row) {
        const balanceCell = row.querySelector('td:nth-child(6)');
        const paidCell = row.querySelector('td:nth-child(5)');
        
        if (balanceCell && paidCell) {
            balanceCell.textContent = `₹${parseFloat(data.new_balance).toFixed(0)}`;
            paidCell.textContent = `₹${parseFloat(data.new_paid).toFixed(0)}`;
            row.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
            setTimeout(() => row.style.backgroundColor = '', 2000);
        }
    }
}

// ✅ Due Date Update Handlers
const dateModal = new bootstrap.Modal(document.getElementById('updateDueDateModal'));
document.addEventListener('click', function(e) {
    if (e.target.closest('.update-date-btn')) {
        const btn = e.target.closest('.update-date-btn');
        const row = btn.closest('tr');
        const studentId = row.dataset.id;
        const studentName = row.dataset.name;
        const dueDate = row.dataset.dueDate;
        
        document.getElementById('duedate_student_id').value = studentId;
        document.getElementById('dueDateStudentName').value = studentName;
        document.getElementById('currentDueDate').value = formatDateForDisplay(dueDate);
        document.getElementById('newDueDate').value = '';
        
        dateModal.show();
    }
});

document.getElementById('submitDueDate').addEventListener('click', function() {
    const studentId = document.getElementById('duedate_student_id').value;
    const newDueDate = document.getElementById('newDueDate').value;
    
    if (!newDueDate) {
        showToast('Validation Error', 'Please select a new due date', 'error');
        return;
    }
    
    const submitBtn = this;
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    submitBtn.disabled = true;
    
    fetch('{% url "enquiry:update_due_date" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: `student_id=${studentId}&new_due_date=${newDueDate}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateDueDateInTable(studentId, newDueDate);
            showToast('Success', 'Due date updated successfully!', 'success');
            dateModal.hide();
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('Error', data.message || 'Failed to update due date', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Network Error', 'Please check your connection and try again', 'error');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function updateDueDateInTable(studentId, newDueDate) {
    const row = document.querySelector(`tr[data-id="${studentId}"]`);
    if (row) {
        const dueDateCell = row.querySelector('.due-badge');
        if (dueDateCell) {
            dueDateCell.innerHTML = formatDateForDisplay(newDueDate);
            dueDateCell.className = 'due-badge';
            
            // Check if new date is overdue
            const today = new Date();
            const dueDate = new Date(newDueDate);
            if (dueDate < today) {
                dueDateCell.classList.add('due-badge-danger');
            }
            
            // Update row data attribute
            row.dataset.dueDate = newDueDate;
            
            // Highlight the updated row
            row.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
            setTimeout(() => row.style.backgroundColor = '', 2000);
        }
    }
}

// ✅ Bulk Operations
function submitSingleAssign(batchId, studentId) {
    if (confirm('Are you sure you want to assign this student to the batch?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/batch/${batchId}/assign/${studentId}/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = getCookie('csrftoken');
        
        const studentInput = document.createElement('input');
        studentInput.type = 'hidden';
        studentInput.name = 'enquiry_ids';
        studentInput.value = studentId;
        
        form.appendChild(csrfInput);
        form.appendChild(studentInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function submitSingleRemove(batchId, studentId) {
    if (confirm('Are you sure you want to remove this student from the batch?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/batch/${batchId}/remove/${studentId}/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = getCookie('csrftoken');
        
        const studentInput = document.createElement('input');
        studentInput.type = 'hidden';
        studentInput.name = 'enquiry_ids';
        studentInput.value = studentId;
        
        form.appendChild(csrfInput);
        form.appendChild(studentInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// ✅ Select All Functionality
document.getElementById('select_all_assigned')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('#assigned input[name="enquiry_ids"]:not([style*="display: none"])');
    checkboxes.forEach(checkbox => {
        if (checkbox.closest('tr').style.display !== 'none') {
            checkbox.checked = this.checked;
        }
    });
});

document.getElementById('select_all_unassigned')?.addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('#unassigned input[name="enquiry_ids"]:not([style*="display: none"])');
    checkboxes.forEach(checkbox => {
        if (checkbox.closest('tr').style.display !== 'none') {
            checkbox.checked = this.checked;
        }
    });
});

// ✅ Form Validation
document.getElementById('bulk-assign-form')?.addEventListener('submit', function(e) {
    const checkedBoxes = document.querySelectorAll('#unassigned input[name="enquiry_ids"]:checked');
    if (checkedBoxes.length === 0) {
        e.preventDefault();
        showToast('Selection Required', 'Please select at least one student to assign', 'warning');
        return false;
    }
    
    if (!confirm(`Are you sure you want to assign ${checkedBoxes.length} student(s) to this batch?`)) {
        e.preventDefault();
        return false;
    }
});

document.getElementById('bulk-remove-form')?.addEventListener('submit', function(e) {
    const checkedBoxes = document.querySelectorAll('#assigned input[name="enquiry_ids"]:checked');
    if (checkedBoxes.length === 0) {
        e.preventDefault();
        showToast('Selection Required', 'Please select at least one student to remove', 'warning');
        return false;
    }
    
    if (!confirm(`Are you sure you want to remove ${checkedBoxes.length} student(s) from this batch?`)) {
        e.preventDefault();
        return false;
    }
});

// ✅ Search Event Listeners
document.getElementById('searchAssigned')?.addEventListener('input', function() {
    searchTable('assigned');
});

document.getElementById('searchUnassigned')?.addEventListener('input', function() {
    searchTable('unassigned');
});

// ✅ Download Functionality
function downloadCSV(data, filename) {
    const csvContent = "data:text/csv;charset=utf-8," + data.map(row => row.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", filename);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function prepareStudentData(tableType) {
    const headers = tableType === 'assigned' 
        ? ["Name", "Contact", "Target Fees", "Paid", "Balance", "Due Date"]
        : ["Name", "Mobile"];
    
    const rows = [];
    rows.push(headers);
    
    // Get all visible rows (including paginated and filtered)
    const visibleRows = filteredData[tableType];
    
    visibleRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const studentData = tableType === 'assigned'
            ? [
                cells[1].textContent.trim(),
                cells[2].textContent.trim(),
                cells[3].textContent.trim().replace('₹', ''),
                cells[4].textContent.trim().replace('₹', ''),
                cells[5].textContent.trim().replace('₹', ''),
                cells[6].textContent.trim()
            ]
            : [
                cells[1].textContent.trim(),
                cells[2].textContent.trim()
            ];
        rows.push(studentData);
    });
    
    return rows;
}

// Event listeners for download buttons
document.getElementById('downloadAssigned')?.addEventListener('click', function() {
    const data = prepareStudentData('assigned');
    const batchCode = "{{ batch.code }}".replace(/\s+/g, '_');
    const filename = `Assigned_Students_${batchCode}_${new Date().toISOString().slice(0,10)}.csv`;
    downloadCSV(data, filename);
    showToast('Download Started', 'Assigned students list is being downloaded', 'success');
});

document.getElementById('downloadUnassigned')?.addEventListener('click', function() {
    const data = prepareStudentData('unassigned');
    const batchCode = "{{ batch.code }}".replace(/\s+/g, '_');
    const filename = `Unassigned_Students_${batchCode}_${new Date().toISOString().slice(0,10)}.csv`;
    downloadCSV(data, filename);
    showToast('Download Started', 'Unassigned students list is being downloaded', 'success');
});

// ✅ Initialize Flatpickr for Date Picker
document.addEventListener('DOMContentLoaded', function() {
    // Initialize date picker
    flatpickr('.datepicker', {
        dateFormat: 'Y-m-d',
        minDate: 'today',
        allowInput: true,
        clickOpens: true,
        theme: 'light'
    });
    
    // Initialize tables
    initializeTable('assigned');
    initializeTable('unassigned');
    
    // Clear search on tab change
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            const targetTab = e.target.getAttribute('data-bs-target');
            if (targetTab === '#assigned') {
                document.getElementById('searchAssigned').value = '';
                searchTable('assigned');
            } else if (targetTab === '#unassigned') {
                document.getElementById('searchUnassigned').value = '';
                searchTable('unassigned');
            }
        });
    });
    
    // Auto-focus search when tab is clicked
    document.getElementById('assigned-tab')?.addEventListener('click', function() {
        setTimeout(() => document.getElementById('searchAssigned')?.focus(), 100);
    });
    
    document.getElementById('unassigned-tab')?.addEventListener('click', function() {
        setTimeout(() => document.getElementById('searchUnassigned')?.focus(), 100);
    });
});

// ✅ Keyboard Shortcuts
document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + F to focus search
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
        e.preventDefault();
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab?.id === 'assigned') {
            document.getElementById('searchAssigned')?.focus();
        } else if (activeTab?.id === 'unassigned') {
            document.getElementById('searchUnassigned')?.focus();
        }
    }
    
    // Escape to clear search
    if (e.key === 'Escape') {
        const activeTab = document.querySelector('.tab-pane.active');
        if (activeTab?.id === 'assigned') {
            const searchInput = document.getElementById('searchAssigned');
            if (searchInput && searchInput.value) {
                searchInput.value = '';
                searchTable('assigned');
            }
        } else if (activeTab?.id === 'unassigned') {
            const searchInput = document.getElementById('searchUnassigned');
            if (searchInput && searchInput.value) {
                searchInput.value = '';
                searchTable('unassigned');
            }
        }
    }
});

// ✅ Performance Optimization - Debounce search
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Apply debounced search
const debouncedAssignedSearch = debounce(() => searchTable('assigned'), 300);
const debouncedUnassignedSearch = debounce(() => searchTable('unassigned'), 300);

// Replace immediate search with debounced versions
document.getElementById('searchAssigned')?.addEventListener('input', debouncedAssignedSearch);
document.getElementById('searchUnassigned')?.addEventListener('input', debouncedUnassignedSearch);

// ✅ Auto-save functionality for forms (optional enhancement)
function autoSaveFormData() {
    const forms = ['bulk-assign-form', 'bulk-remove-form'];
    forms.forEach(formId => {
        const form = document.getElementById(formId);
        if (form) {
            const checkboxes = form.querySelectorAll('input[type="checkbox"][name="enquiry_ids"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const selectedIds = Array.from(form.querySelectorAll('input[name="enquiry_ids"]:checked'))
                                          .map(cb => cb.value);
                    // Store in memory (not localStorage as per artifact restrictions)
                    window.selectedStudents = window.selectedStudents || {};
                    window.selectedStudents[formId] = selectedIds;
                });
            });
        }
    });
}

// ✅ Initialize auto-save on page load
document.addEventListener('DOMContentLoaded', autoSaveFormData);

// ✅ Utility function to highlight table rows on hover
function addTableHoverEffects() {
    const tables = ['assigned-table', 'unassigned-table'];
    tables.forEach(tableId => {
        const table = document.getElementById(tableId);
        if (table) {
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                row.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = 'rgba(13, 110, 253, 0.05)';
                });
                row.addEventListener('mouseleave', function() {
                    if (!this.style.backgroundColor.includes('rgba(16, 185, 129')) {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }
    });
}

// Initialize hover effects
document.addEventListener('DOMContentLoaded', addTableHoverEffects);

console.log('Batch management script loaded successfully!');
</script>

{% endblock %}