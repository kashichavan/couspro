{% extends "base.html" %}
{% load humanize %}
{% block content %}
{% load custom_filters %}

<div class="container-fluid py-4">
  <!-- Month Filter Header -->
  <div class="card mb-4 fade-in">
    <div class="card-body">
      <form id="month-filter-form" class="row g-3 align-items-end">
        <div class="col-md-4">
          <label for="month-select" class="form-label fw-bold">Select Month</label>
          <select id="month-select" name="month" class="form-select form-select-lg">
            <option value="">All Time</option>
            {% for value, label in month_choices %}
              <option value="{{ value }}" {% if value == selected_month %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="col-md-3">
          <button type="submit" class="btn btn-primary btn-lg px-4">
            <i class="fas fa-filter me-2"></i>Filter Data
          </button>
          <button type="button" id="reset-btn" class="btn btn-outline-secondary btn-lg px-4 ms-2">
            <i class="fas fa-undo me-2"></i>Reset
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Stats Summary Cards -->
<div class="row g-4 mb-4">
  <!-- Total Telephonic -->
  <div class="col-md-2">
    <div class="card bg-light border-start border-4 border-info">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <i class="fas fa-phone-alt fa-2x text-info"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <p class="mb-1 text-muted">Total Telephonic</p>
            <h4 class="mb-0" id="total-telephonic">0</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Total Walkin -->
  <div class="col-md-2">
    <div class="card bg-light border-start border-4 border-warning">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <i class="fas fa-walking fa-2x text-warning"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <p class="mb-1 text-muted">Total Walkin</p>
            <h4 class="mb-0" id="total-walkin">0</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Joined -->
  <div class="col-md-2">
    <div class="card bg-light border-start border-4 border-success">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <i class="fas fa-user-graduate fa-2x text-success"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <p class="mb-1 text-muted">Total Joined</p>
            <h4 class="mb-0" id="total-joined">0</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pending -->
  <div class="col-md-2">
    <div class="card bg-light border-start border-4 border-warning">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <i class="fas fa-user-clock fa-2x text-warning"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <p class="mb-1 text-muted">Pending</p>
            <h4 class="mb-0" id="total-pending">0</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dropout -->
  <div class="col-md-2">
    <div class="card bg-light border-start border-4 border-danger">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <i class="fas fa-user-minus fa-2x text-danger"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <p class="mb-1 text-muted">Dropouts</p>
            <h4 class="mb-0" id="total-dropout">0</h4>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Fees Collected -->
  <div class="col-md-2">
    <div class="card bg-light border-start border-4 border-info">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="flex-shrink-0">
            <i class="fas fa-money-bill-wave fa-2x text-info"></i>
          </div>
          <div class="flex-grow-1 ms-3">
            <p class="mb-1 text-muted">Fees Collected</p>
            <h4 class="mb-0" id="total-fees">₹0</h4>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Table -->
<table id="counsellor-table" class="table table-striped table-hover table-bordered align-middle">
  <thead class="table-dark">
    <tr>
      <!-- Primary Columns -->
      <th>Counsellor</th>
      
      <!-- Walkin Group -->
      <th>Walkin</th>
      <th>J</th>
      <th>P</th>
      <th>D</th>

      <!-- Telephonic Group -->
      <th>Telephonic</th>
      <th>J</th>
      <th>P</th>
      <th>D</th>

      <!-- Status Totals -->
      <th>Joined</th>
      <th>Pending</th>
      <th>Dropout</th>
      
      <!-- Financials -->
      <th>Fees Collected</th>
      <th>Pending Balance</th>
    </tr>
  </thead>
  <tbody id="table-body">
    {% for stat in stats %}
    <tr data-counsellor-id="{{ stat.counsellor.id }}" class="table-row">
      <!-- Counsellor -->
      <td class="counsellor-cell">
        {% with selected_month|split_month as month_data %}
          <a href="{% url 'enquiry:counsellor_monthly_details' counsellor_id=stat.counsellor.id year=month_data.year month=month_data.month %}">
            {{ stat.counsellor.name }}
          </a>
        {% endwith %}
      </td>

      <!-- Walkin Group -->
      <td class="text-center"><span class="badge bg-warning">{{ stat.total_walkin }}</span></td>
      <td class="text-center">{{ stat.joined_walkin }}</td>
      <td class="text-center">{{ stat.pending_walkin }}</td>
      <td class="text-center">{{ stat.dropout_walkin }}</td>

      <!-- Telephonic Group -->
      <td class="text-center"><span class="badge bg-info">{{ stat.total_telephonic }}</span></td>
      <td class="text-center">{{ stat.joined_telephonic }}</td>
      <td class="text-center">{{ stat.pending_telephonic }}</td>
      <td class="text-center">{{ stat.dropout_telephonic }}</td>

      <!-- Status Totals -->
      <td class="text-center"><span class="status-badge status-joined">{{ stat.joined }}</span></td>
      <td class="text-center"><span class="status-badge status-pending">{{ stat.pending }}</span></td>
      <td class="text-center"><span class="status-badge status-dropout">{{ stat.dropout }}</span></td>

      <!-- Financials -->
      <td class="fees-collected text-end">₹{{ stat.fees_paid|intcomma }}</td>
      <td class="fees-pending text-end text-danger">₹{{ stat.fees_balance|intcomma }}</td>
    </tr>
    {% empty %}
    <tr>
      <td colspan="14" class="text-center py-4">
        <i class="fas fa-search fa-2x text-muted mb-2"></i>
        <p class="text-muted">No data found</p>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

{% endblock %}

{% block extra_js %}
<!-- DataTables JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"> 
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script> 
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script> 

<style>
.status-badge {
    padding: 0.4em 0.6em;
    border-radius: 0.25em;
    font-weight: bold;
}
.status-joined { background-color: #d4edda; color: #155724; }
.status-pending { background-color: #fff3cd; color: #856404; }
.status-dropout { background-color: #f8d7da; color: #721c24; }
</style>

<script>
$(document).ready(function() {
    // Initialize DataTable
    let table = $('#counsellor-table').DataTable({
        responsive: true,
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        language: {
            search: "Search counsellors:",
            lengthMenu: "Show _MENU_ entries",
            info: "Showing _START_ to _END_ of _TOTAL_ entries",
            paginate: {
                first: "First",
                last: "Last",
                next: "Next",
                previous: "Previous"
            }
        }
    });

    // Handle month filter submission
    $('#month-filter-form').on('submit', function(e) {
        e.preventDefault();
        const selectedMonth = $('#month-select').val();
        
        // Update download link
        $('#download-link').attr('href', 
            "{% url 'enquiry:download_monthly_summary_by_counsellor_excel' %}?month=" + selectedMonth
        );

        // Show loading spinner
        $('#table-container').hide();
        $('#loading-spinner').show();
        $('#error-message').addClass('d-none');

        // Fetch filtered data
        $.ajax({
            url: "{% url 'enquiry:monthly_summary_by_counsellor' %}",
            type: 'GET',
            data: {
                month: selectedMonth
            },
            success: function(response) {
                // Extract table HTML from response
                const parser = new DOMParser();
                const htmlDoc = parser.parseFromString(response, 'text/html');
                const newTableHtml = $(htmlDoc).find('#counsellor-table').html();

                // Update table content
                $('#counsellor-table').html(newTableHtml);
                
                // Reinitialize DataTable
                table.destroy();
                table = $('#counsellor-table').DataTable({
                    responsive: true,
                    paging: true,
                    searching: true,
                    ordering: true,
                    info: true,
                    language: {
                        search: "Search counsellors:",
                        lengthMenu: "Show _MENU_ entries",
                        info: "Showing _START_ to _END_ of _TOTAL_ entries",
                        paginate: {
                            first: "First",
                            last: "Last",
                            next: "Next",
                            previous: "Previous"
                        }
                    }
                });

                // Update summary stats
                updateSummaryStats();
            },
            error: function() {
                $('#error-message').removeClass('d-none');
            },
            complete: function() {
                $('#loading-spinner').hide();
                $('#table-container').show();
            }
        });
    });

    // Reset button handler
    $('#reset-btn').on('click', function() {
        $('#month-select').val('');
        $('#month-filter-form').submit();
    });

    // Initial stats update
    updateSummaryStats();

    function updateSummaryStats() {
    let totalTelephonic = 0;
    let totalWalkin = 0;
    let totalJoined = 0;
    let totalPending = 0;
    let totalDropout = 0;
    let totalFees = 0;

    $('#counsellor-table tbody tr').each(function() {
        // Total Walkin (column 1)
        totalWalkin += parseInt($(this).find('td:eq(1)').text()) || 0;
        
        // Total Telephonic (column 5)
        totalTelephonic += parseInt($(this).find('td:eq(5)').text()) || 0;

        // Total Joined (column 10)
        totalJoined += parseInt($(this).find('td:eq(10)').text()) || 0;

        // Total Pending (column 11)
        totalPending += parseInt($(this).find('td:eq(11)').text()) || 0;

        // Total Dropout (column 12)
        totalDropout += parseInt($(this).find('td:eq(12)').text()) || 0;

        // Fees Collected (column 13)
        const feesText = $(this).find('td:eq(13)').text().replace('₹', '').replace(/,/g, '');
        totalFees += parseInt(feesText) || 0;
    });

    // Format numbers with commas
    const formattedFees = new Intl.NumberFormat('en-IN').format(totalFees);
    
    // Update stats
    $('#total-telephonic').text(totalTelephonic);
    $('#total-walkin').text(totalWalkin);
    $('#total-joined').text(totalJoined);
    $('#total-pending').text(totalPending);
    $('#total-dropout').text(totalDropout);
    $('#total-fees').text('₹' + formattedFees);
}
});
</script>
{% endblock %}